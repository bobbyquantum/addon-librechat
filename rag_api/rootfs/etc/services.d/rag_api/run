#!/usr/bin/with-contenv bashio
# shellcheck shell=bash
set -e

# Wait for PostgreSQL to be ready
bashio::log.info "Waiting for PostgreSQL to be ready..."
until bashio::net.wait_for 5432 && su postgres -c "pg_isready" 2>/dev/null; do
    bashio::log.info "PostgreSQL is not ready yet. Waiting..."
    sleep 2
done

# Set environment variables
export POSTGRES_DB="ragapi"
export POSTGRES_USER="postgres"
export POSTGRES_PASSWORD=""  # No password for local connections
export DB_HOST="localhost"
export DB_PORT="5432"

# Start the RAG API
bashio::log.info "Starting RAG API..."
cd /app
exec uvicorn main:app --host 0.0.0.0 --port 8000
